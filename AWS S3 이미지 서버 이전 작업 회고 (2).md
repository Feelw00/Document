# AWS S3 이미지 서버 이전 작업 회고 (2)

본 문서는 기존 서버 스토리지에 저장되던 이미지를 AWS S3로 이전하는 작업에 대한 회고록입니다.
서버 스펙 : Ubuntu(22.04) + PHP(7.3)


## 서론
AWS의 EFS 서비스를 통해 이미지 폴더를 네트워크로 공유하게 되었고 의도했던대로 스케일아웃 시 이미지를 공유 할 수 있게 되었습니다.

하지만 EFS 서비스에 의존하기에는 리소스 이동 딜레이와 스토리지 크기 증가 등의 단점이 있었습니다.

당장의 이벤트를 마무리한 뒤 근본적인 문제를 해결하기 위해 이미지 서버를 이전하기로 결정했습니다.


## 이미지 서버 S3 이전
기존에도 모든 인프라를 AWS로 구성하고 있었기 때문에 S3로 이미지 서버를 이전하는 것이 가장 안정적이고 효율적이라고 판단했습니다.

이미지 서버를 S3로 이전하기 위해 다음과 같은 작업을 진행했습니다.

1. 이미지 저장용 S3 Bucket 생성
2. 이미지 캐싱을 위한 CloudFront 생성
3. 기존 이미지 경로를 CloudFront로 변경
4. AWS SDK 사용을 위한 Composer 설치
5. 기존 이미지 업로드 코드 수정

기존 이미지 업로드 로직이 순수 PHP로 작성되어 있었고 Class 사용 없이 함수로만 작성되어 있었기 때문에 Composer를 사용하기 위해 추가적으로 기존 로직을 수정해야 했으며,

또한 기존 이미지 경로가 변수로 관리되지 않고 하드코딩되어 있거나 Database에 경로가 포함되어 저장되어있는 등 수정 및 테스트에 많은 시간이 소요되었습니다.


## 이미지 리사이징
이미지 서버를 S3로 이전하는 것은 성공하였으나 한 가지 문제가 발생했습니다.

기존 사용하고 있던 이미지 리사이징 라이브러리가 스토리지의 이미지 리사이징만 지원하고 있었기 때문에 S3 업로드 시 이미지 리사이징을 위한 작업이 필요했습니다.

이미지 리사이징 라이브러리를 수정하기에는 시간이 많이 소요될 것이라 판단하여 AWS Lambda를 사용하여 이미지 리사이징을 진행하기로 결정했습니다.

다음은 Lambda 함수를 사용한 이미지 리사이징 사이클입니다.

1. S3 Bucket에 이미지 업로드
2. 특정 S3 Bucket에 이미지가 업로드 되면 Lambda 함수 트리거
3. Lambda 함수에서 이미지 리사이징 후 사이즈 별 Bucket에 저장

Lambda 함수를 통한 이미지 리사이징 작업은 성공적으로 진행되었으나 예상하지 못한 사이드 이펙트가 발생했습니다.

이미지 리사이징 시 이미지가 업로드 되는 시점과 리사이징이 완료되는 시점이 달라 발생한 문제로 이미지 업로드 후 순간적으로 이미지가 출력되지 않는 현상이 발생하였습니다.

이를 해결하기 위해 리사이징 Lambda 함수 완료 시 이미지 데이터를 DB에 저장하는 방법등을 고려하였으나 이미지 리사이징의 경우 관리자 페이지에서만 사용되는 기능이기 때문에 사용자에게 영향을 주지 않는다고 판단하여 별도의 조치를 취하지 않기로 결정했습니다.


## 마치며
이미지 서버를 S3로 이전하는 작업은 예상보다 많은 시간과 노력이 필요했지만 성공적으로 마무리할 수 있었습니다.

이미지 서버를 S3로 이전함으로써 스케일 아웃 시 이미지를 공유할 수 있게 되었으며 이미지 리사이징을 위해 Lambda 사용 경험 또한 쌓을 수 있었습니다.

확장성을 고려하지 않은 시스템을 운영 중인 상황에서 개선하는 것은 어렵고 힘든 일이라는 것을 다시 한 번 느끼게 되었습니다.